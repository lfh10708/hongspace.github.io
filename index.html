<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="宏の博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="宏の博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宏の博客">






  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>宏の博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">宏の博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/25/进入docker容器内部以及连接外网网络/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/25/进入docker容器内部以及连接外网网络/" class="post-title-link" itemprop="url">进入docker容器内部以及连接外网网络</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-25 09:08:27" itemprop="dateCreated datePublished" datetime="2019-03-25T09:08:27+08:00">2019-03-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-26 12:40:57" itemprop="dateModified" datetime="2019-03-26T12:40:57+08:00">2019-03-26</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在前面搭建了 docker 之后，我想让 springboot 项目连接外部网络。<br>那么问题来了：<br>目前我不清楚 docker 容器是否能联通宿主机网络。</p>
<h2 id="进入-docker-容器的终端"><a href="#进入-docker-容器的终端" class="headerlink" title="进入 docker 容器的终端"></a>进入 docker 容器的终端</h2><p>一种方式是给通过 ssh 访问 docker 容器，但是我们还不知道 docker容器 的 ip 地址，所以还是得靠另一种方式去访问。</p>
<p>查看在运行的容器（下面这个是我之前搭建的 docker 仓库容器）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dockerrepository soft]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">9090d5948515        registry            &quot;/entrypoint.sh /e...&quot;   About an hour ago   Up About an hour    0.0.0.0:5000-&gt;5000/tcp   registry</span><br></pre></td></tr></table></figure></p>
<p>下面使用 docker exec -it 命令进入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dockerrepository soft]# docker exec -it 9090d5948515 sh</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure></p>
<p>进到如下界面，说明进入终端成功了。输入 <code>ip addr</code> 命令查看ip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ # ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">33: eth0@if34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:acff:fe11:2/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>
<p>ip 信息成功出来了。</p>
<h2 id="连接外部-mysql"><a href="#连接外部-mysql" class="headerlink" title="连接外部 mysql"></a>连接外部 mysql</h2><p>mysql 的 ip 地址是 192.168.56.1，这里虽然 docker 内部的 ip 段不在同一个段内，但是我们可以尝试 ping 一下先<br>结果发现 ping 的通。</p>
<p>那我们直接改造一下就可以了。</p>
<p>#错误集锦</p>
<h2 id="进入终端报-rpc-error-code-2-desc-oci-runtime-error-exec-failed-container-linux-go-247-starting-container-process-caused-“exec-”-bin-bash-”-stat-bin-bash-no-such-file-or-directory”"><a href="#进入终端报-rpc-error-code-2-desc-oci-runtime-error-exec-failed-container-linux-go-247-starting-container-process-caused-“exec-”-bin-bash-”-stat-bin-bash-no-such-file-or-directory”" class="headerlink" title="进入终端报 rpc error: code = 2 desc = oci runtime error: exec failed: container_linux.go:247: starting container process caused “exec: \”/bin/bash\”: stat /bin/bash: no such file or directory”"></a>进入终端报 rpc error: code = 2 desc = oci runtime error: exec failed: container_linux.go:247: starting container process caused “exec: \”/bin/bash\”: stat /bin/bash: no such file or directory”</h2><p>是命令的原因：这里使用的是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it registry /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>改成了下方的就好了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it registry sh</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/22/搭建docker私有仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/22/搭建docker私有仓库/" class="post-title-link" itemprop="url">搭建docker私有仓库</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-22 11:07:58 / 修改时间：17:23:26" itemprop="dateCreated datePublished" datetime="2019-03-22T11:07:58+08:00">2019-03-22</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本次用来做 docker 仓库的环境说明如下：<br>  系统：CentOS 7.6<br>  docker版本： 1.13.1<br>  ip地址：<br>  仓库： 192.168.56.99 hostname为centos7<br>  本地：192.168.56.100 hostname为dockerrepository</p>
</blockquote>
<h1 id="运行-docker-仓库"><a href="#运行-docker-仓库" class="headerlink" title="运行 docker 仓库"></a>运行 docker 仓库</h1><h2 id="拉取-docker-registry-镜像"><a href="#拉取-docker-registry-镜像" class="headerlink" title="拉取 docker registry 镜像"></a>拉取 docker registry 镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io/registry</span><br></pre></td></tr></table></figure>
<h2 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h2><p>启动前我们用 <code>docker inspect</code> 命令，看一下需要images需要挂载的盘：看到 Volumes 参参数</p>
<pre><code>&quot;Volumes&quot;: {
    &quot;/var/lib/registry&quot;: {}
},
</code></pre><p>下面运行该镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always --name=registry -v /soft/docker/repository:/var/lib/registry --privileged=true registry</span><br></pre></td></tr></table></figure>
<ul>
<li>-d：后台运行<br>-p：将容器的5000端口映射到宿主机的5000端口<br>–restart：docker服务重启后总是重启此容器<br>–name：容器的名称<br>-v：将容器内的 /var/lib/registry 映射到宿主机的 /soft/docker/repository 目录</li>
</ul>
<h2 id="上传-docker-镜像"><a href="#上传-docker-镜像" class="headerlink" title="上传 docker 镜像"></a>上传 docker 镜像</h2><h3 id="先获取一个-hello-world-镜像"><a href="#先获取一个-hello-world-镜像" class="headerlink" title="先获取一个 hello-world 镜像"></a>先获取一个 hello-world 镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull library/hello-world</span><br></pre></td></tr></table></figure>
<h3 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># docker images</span><br><span class="line">REPOSITORY              TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/registry      latest              f32a97de94e1        2 weeks ago         25.8 MB</span><br><span class="line">docker.io/hello-world   latest              fce289e99eb9        2 months ago        1.84 kB</span><br></pre></td></tr></table></figure>
<h3 id="镜像命名"><a href="#镜像命名" class="headerlink" title="镜像命名"></a>镜像命名</h3><p>镜像的名字由两部分组成：repository 和 tag。<br>[image name] = [repository]:[tag]</p>
<p>接下来我们对上面的 hello-world 进行重命名:docker tag IMAGEID(镜像id) REPOSITORY:TAG（仓库：标签）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag fce289e99eb9 192.168.56.99:5000/hello:v1.0</span><br></pre></td></tr></table></figure></p>
<p><strong> 注意：这里不能用大写字母，不然会报错：xxx is not a valid repository/tag </strong></p>
<p>再次用 <code>docker images</code>发现是拷贝了一个 images 出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# docker images</span><br><span class="line">REPOSITORY                 TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test-docker                latest              4348eee9a514        23 hours ago        121 MB</span><br><span class="line">docker.io/openjdk          8-jdk-alpine        e9ea51023687        2 weeks ago         105 MB</span><br><span class="line">192.168.56.99:5000/hello   v1.0                fce289e99eb9        2 months ago        1.84 kB</span><br><span class="line">docker.io/hello-world      latest              fce289e99eb9        2 months ago        1.84 kB</span><br></pre></td></tr></table></figure></p>
<h3 id="推送镜像到私有仓库"><a href="#推送镜像到私有仓库" class="headerlink" title="推送镜像到私有仓库"></a>推送镜像到私有仓库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 docker]# docker push 192.168.56.99:5000/hello:v1.0</span><br><span class="line">The push refers to a repository [192.168.56.99:5000/hello]</span><br><span class="line">af0b15c8625b: Pushed </span><br><span class="line">v1.0: digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a size: 524</span><br></pre></td></tr></table></figure>
<p>查看仓库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dockerrepository soft]# curl 192.168.56.99:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;hello&quot;]&#125;</span><br></pre></td></tr></table></figure></p>
<p>推送成功~</p>
<h3 id="拉取私有库的镜像"><a href="#拉取私有库的镜像" class="headerlink" title="拉取私有库的镜像"></a>拉取私有库的镜像</h3><p>先删除本地的私有镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 docker]# docker rmi 192.168.56.99:5000/hello:v1.0</span><br><span class="line">Untagged: 192.168.56.99:5000/hello:v1.0</span><br><span class="line">Untagged: 192.168.56.99:5000/hello@sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br></pre></td></tr></table></figure>
<p>再拉取该镜像：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Trying to pull repository 192.168.56.99:5000/hello ... </span><br><span class="line">v1.0: Pulling from 192.168.56.99:5000/hello</span><br><span class="line">Digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">Status: Downloaded newer image for 192.168.56.99:5000/hello:v1.0</span><br></pre></td></tr></table></figure></p>
<p>再运行一次的话，会获得最新版本的镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 docker]# docker pull 192.168.56.99:5000/hello:v1.0</span><br><span class="line">Trying to pull repository 192.168.56.99:5000/hello ... </span><br><span class="line">v1.0: Pulling from 192.168.56.99:5000/hello</span><br><span class="line">Digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">Status: Image is up to date for 192.168.56.99:5000/hello:v1.0</span><br></pre></td></tr></table></figure>
<p>具体的api得查看官方文档：<br><a href="https://docs.docker.com/registry/spec/api/" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/api/</a></p>
<h2 id="搭建-web-服务"><a href="#搭建-web-服务" class="headerlink" title="搭建 web 服务"></a>搭建 web 服务</h2><p>为了方便管理，我们需给其搭建一个 web 后台界面来访问</p>
<h1 id="错误集锦"><a href="#错误集锦" class="headerlink" title="错误集锦"></a>错误集锦</h1><h2 id="推送报错"><a href="#推送报错" class="headerlink" title="推送报错"></a>推送报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The push refers to a repository [192.168.56.99:5000/hello]</span><br><span class="line">An image does not exist locally with the tag: 192.168.56.99:5000/hello</span><br></pre></td></tr></table></figure>
<p>原因：<br>重名名的时候要指定好其对应的仓库，不然就是默认的docker仓库（DockerHub）<br>正确格式应该为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag imageId 仓库地址/新的名称:tag</span><br></pre></td></tr></table></figure></p>
<h2 id="还是推送报错（没错，我就是这么皮！）-http-server-gave-HTTP-response-to-HTTPS-client"><a href="#还是推送报错（没错，我就是这么皮！）-http-server-gave-HTTP-response-to-HTTPS-client" class="headerlink" title="还是推送报错（没错，我就是这么皮！） http: server gave HTTP response to HTTPS client"></a>还是推送报错（没错，我就是这么皮！） http: server gave HTTP response to HTTPS client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The push refers to a repository [192.168.56.99:5000/hello]</span><br><span class="line">Get https://192.168.56.99:5000/v1/_ping: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
<p>解决办法: 修改 /etc/docker/deamon.json 文件配置私有仓库。</p>
<ol>
<li>要先去配置私有仓库，按照前面的配置。仓库的地址为 192.168.56.99:5000 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>加入insecure-registries配置：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://registry.dockercn.com"</span>,<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>],</span><br><span class="line">  <span class="attr">"insecure-registries"</span>: [<span class="string">"192.168.56.99:5000"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重启docker<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<h3 id="仍旧是推送报错（没想到吧-）"><a href="#仍旧是推送报错（没想到吧-）" class="headerlink" title="仍旧是推送报错（没想到吧~）"></a>仍旧是推送报错（没想到吧~）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The push refers to a repository [192.168.56.99:5000/hello]</span><br><span class="line">af0b15c8625b: Retrying in 1 second</span><br></pre></td></tr></table></figure>
<p>到192.168.56.99上看一下docker日志。-f 代表持续输出文件内容。registry是我们仓库容器的命名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f registry</span><br></pre></td></tr></table></figure></p>
<p>看到下面的内容,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2019-03-22T08:25:42.217991747Z&quot; level=error msg=&quot;response completed with error&quot; err.code=unknown err.detail=&quot;filesystem: mkdir /var/lib/registry/docker: permission denied&quot; err.message=&quot;unknown error&quot; go.version=go1.11.2 http.request.host=&quot;192.168.56.99:5000&quot; http.request.id=750b0e5a-c508-4e9c-89b9-8b4dbbecdca4 http.request.method=POST http.request.remoteaddr=&quot;192.168.56.100:47320&quot; http.request.uri=&quot;/v2/hello/blobs/uploads/&quot; http.request.useragent=&quot;docker/1.13.1 go/go1.10.3 kernel/3.10.0-957.10.1.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/1.13.1 \(linux\))&quot; http.response.contenttype=&quot;application/json; charset=utf-8&quot; http.response.duration=1.348042ms http.response.status=500 http.response.written=164 vars.name=hello</span><br></pre></td></tr></table></figure></p>
<p>注意这一句：<strong>filesystem: mkdir /var/lib/registry/docker: permission denied</strong></p>
<p>是因为CentOS7中的安全模块selinux把权限禁掉了。我们在启动 registry 的时候要给 registry 添加 –privileged=true 参数</p>
<p>启动仓库的时候用下面命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always  -v /soft/docker/repository:/var/lib/registry --privileged=true registry</span><br></pre></td></tr></table></figure></p>
<p><strong>注意这个时候就不要加上 –name 属性了，因为名为registry 的容器已经存在了</strong></p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="http://kekefund.com/2017/06/07/doker-registry/" target="_blank" rel="noopener">docker私有仓库搭建</a></li>
<li><a href="https://www.ibm.com/developerworks/community/blogs/132cfa78-44b0-4376-85d0-d3096cd30d3f/entry/%E9%95%9C%E5%83%8F%E5%91%BD%E5%90%8D%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5_%E6%AF%8F%E5%A4%A95%E5%88%86%E9%92%9F%E7%8E%A9%E8%BD%AC_Docker_%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF_18?lang=en" target="_blank" rel="noopener">镜像命名的最佳实践 - 每天5分钟玩转 Docker 容器技术</a></li>
<li>[私有仓库]<a href="https://yeasy.gitbooks.io/docker_practice/repository/registry.html" target="_blank" rel="noopener">https://yeasy.gitbooks.io/docker_practice/repository/registry.html</a></li>
<li><a href="https://blog.csdn.net/jiankunking/article/details/71190814" target="_blank" rel="noopener">Docker 私有仓库，上传镜像报错：server gave HTTP response to HTTPS client</a></li>
<li><a href="https://segmentfault.com/a/1190000017955885" target="_blank" rel="noopener">Docker: 上传镜像至私有仓库</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/Springboot使用Maven打包镜像到Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/Springboot使用Maven打包镜像到Docker/" class="post-title-link" itemprop="url">Springboot 使用 Maven 打包 Docker</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 18:13:24" itemprop="dateCreated datePublished" datetime="2019-03-21T18:13:24+08:00">2019-03-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-26 12:43:39" itemprop="dateModified" datetime="2019-03-26T12:43:39+08:00">2019-03-26</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Springboot-使用-Maven-打包-Docker"><a href="#Springboot-使用-Maven-打包-Docker" class="headerlink" title="Springboot 使用 Maven 打包 Docker"></a>Springboot 使用 Maven 打包 Docker</h1><blockquote>
<p>本文主要是参考 <a href="http://www.ityouknow.com/springboot/2018/03/19/spring-boot-docker.html" target="_blank" rel="noopener">Spring Boot 2 (四)：使用 Docker 部署 Spring Boot–纯洁的微笑</a> 动手进行测试的一个过程。</p>
</blockquote>
<table>
<thead>
<tr>
<th>版本</th>
<th>开发环境系统</th>
<th>docker 环境系统</th>
<th>开发环境 与 docker 是否在同一机器上</th>
</tr>
</thead>
<tbody>
<tr>
<td>纯洁的微笑</td>
<td>centos7</td>
<td>centos7</td>
<td>是</td>
</tr>
<tr>
<td>v1.0</td>
<td>win10</td>
<td>win10</td>
<td>是</td>
</tr>
<tr>
<td>v1.1</td>
<td>win10</td>
<td>centos7</td>
<td>否（centos7是在win下的虚拟机上）</td>
</tr>
<tr>
<td>v1.2</td>
<td>win10</td>
<td>centos7</td>
<td>否（centos7是在win下的虚拟机上）</td>
</tr>
</tbody>
</table>
<p>docker 版本为1.13.1</p>
<h1 id="V1-0"><a href="#V1-0" class="headerlink" title="V1.0"></a>V1.0</h1><p>按照 「纯洁的微笑」 版本进行，只不过我的项目名称是  test-docker </p>
<p>过程中出了一点问题：参考 错误集锦 第一个</p>
<h1 id="V1-1"><a href="#V1-1" class="headerlink" title="V1.1"></a>V1.1</h1><blockquote>
<p>小插曲：在把 win10 下的 docker 环境变成虚拟机中的环境时，win10 下需要把 Hype-v 功能关掉，才可以安装VMware 或者 VBox 等虚拟机软件，因此我在关掉 Hype-v 后直接把 win10 下的 docker 卸载了（win10下的docker 依赖 Hype-v 的启动）</p>
</blockquote>
<p>win10 地址是 192.168.56.1， centos7 的地址是 192.168.56.100</p>
<p>由于 docker 所在的 ip 变更，maven 打包 docker 时是默认使用的是 localhost:2375 端口。 此时打包会出现如下错误：</p>
<blockquote>
<p>Caused by: org.apache.http.conn.HttpHostConnectException: Connect to localhost:2375 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused: connect<br>    at org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:151)<br>    at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:353)<br>    at org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:380)<br>    at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)<br>    at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:184)<br>    at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:88)<br>    at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:110)<br>    at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:184)<br>    at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:71)<br>    at org.glassfish.jersey.apache.connector.ApacheConnector.apply(ApacheConnector.java:435)<br>    … 21 more</p>
</blockquote>
<p>这个时候就要在 maven 插件里面配置好 docker-Host </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>src/main/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 添加远程docker主机，该主机必须开启了远程API，监听2375端口有两种方式添加docker主机 --&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 在系统环境变量中添加DOCKER_HOST系统变量，值为tcp://docker-host-ip:2375 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>http://192.168.56.100:2375<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时 centos7 的 docker 已经运行，不过打包编译后却发现报了这个错</p>
<blockquote>
<p>Caused by: org.apache.http.conn.HttpHostConnectException: Connect to 192.168.56.100:2375 [/192.168.56.100] failed: Connection refused: connect</p>
</blockquote>
<p>这个是远端 docker 的2375端口没有开放。</p>
<h2 id="开放远程-docker-的端口"><a href="#开放远程-docker-的端口" class="headerlink" title="开放远程 docker 的端口"></a>开放远程 docker 的端口</h2><p>参考<a href="https://blog.csdn.net/achenyuan/article/details/80253673" target="_blank" rel="noopener">Docker学习笔记 — 开启Docker远程访问</a></p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>修改/etc/sysconfig/docker文件，在最后增加一行DOCKER_OPTS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=&quot;-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock&quot;</span><br></pre></td></tr></table></figure>
<p>改完如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># To use docker-latest client, uncomment below lines</span><br><span class="line">#DOCKERBINARY=/usr/bin/docker-latest</span><br><span class="line">#DOCKERDBINARY=/usr/bin/dockerd-latest</span><br><span class="line">#DOCKER_CONTAINERD_BINARY=/usr/bin/docker-containerd-latest</span><br><span class="line">#DOCKER_CONTAINERD_SHIM_BINARY=/usr/bin/docker-containerd-shim-latest</span><br><span class="line">DOCKER_OPTS=&quot;-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock&quot;</span><br></pre></td></tr></table></figure></p>
<p>修改/usr/lib/systemd/system/docker.service，在[Service]的ExexStart=下面增加一行$DOCKER_OPTS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">NotifyAccess=main</span><br><span class="line">EnvironmentFile=-/run/containers/registries.conf</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/docker</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/docker-storage</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/docker-network</span><br><span class="line">Environment=GOTRACEBACK=crash</span><br><span class="line">Environment=DOCKER_HTTP_HOST_COMPAT=1</span><br><span class="line">Environment=PATH=/usr/libexec/docker:/usr/bin:/usr/sbin</span><br><span class="line">ExecStart=/usr/bin/dockerd-current \</span><br><span class="line">          --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current \</span><br><span class="line">          --default-runtime=docker-runc \</span><br><span class="line">          --exec-opt native.cgroupdriver=systemd \</span><br><span class="line">          --userland-proxy-path=/usr/libexec/docker/docker-proxy-current \</span><br><span class="line">          --init-path=/usr/libexec/docker/docker-init-current \</span><br><span class="line">          --seccomp-profile=/etc/docker/seccomp.json \</span><br><span class="line">          $DOCKER_OPTS \</span><br><span class="line">          $OPTIONS \</span><br><span class="line">          $DOCKER_STORAGE_OPTIONS \</span><br><span class="line">          $DOCKER_NETWORK_OPTIONS \</span><br><span class="line">          $ADD_REGISTRY \</span><br><span class="line">          $BLOCK_REGISTRY \</span><br><span class="line">          $INSECURE_REGISTRY \</span><br><span class="line">          $REGISTRIES</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">LimitNPROC=1048576</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Restart=on-abnormal</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="docker重新读取配置文件，重新启动docker服务"><a href="#docker重新读取配置文件，重新启动docker服务" class="headerlink" title="docker重新读取配置文件，重新启动docker服务"></a>docker重新读取配置文件，重新启动docker服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<h3 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep docker</span><br></pre></td></tr></table></figure>
<p>出现如下内容表示端口开放成功</p>
<blockquote>
<p>root       928     1  0 09:34 ?        00:00:00 /usr/bin/dockerd-current -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock</p>
</blockquote>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>这时候回到 win10 下再次打包我们的 Springboot程序到 docker ，发现能够成功。<br>到 centos7 上运行 docker images 命令，看到镜像已经打包成功了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test-docker         latest              332af44686d2        41 seconds ago      121 MB</span><br></pre></td></tr></table></figure></p>
<h2 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 -t test-docker</span><br></pre></td></tr></table></figure>
<p>成功，访问 <a href="http://192.168.56.100:8080/" target="_blank" rel="noopener">http://192.168.56.100:8080/</a></p>
<h1 id="v1-3-springboot-连接数据库"><a href="#v1-3-springboot-连接数据库" class="headerlink" title="v1.3 springboot 连接数据库"></a>v1.3 springboot 连接数据库</h1><h2 id="在原来的项目上添加上下面的application-properties文件"><a href="#在原来的项目上添加上下面的application-properties文件" class="headerlink" title="在原来的项目上添加上下面的application.properties文件"></a>在原来的项目上添加上下面的application.properties文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://192.168.56.1:3306/test</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line">spring.datasource.max-idle=10</span><br><span class="line">spring.datasource.max-wait=1000</span><br><span class="line">spring.datasource.min-idle=5</span><br><span class="line">spring.datasource.initial-size=5</span><br><span class="line">server.tomcat.uri-encoding=UTF-8</span><br></pre></td></tr></table></figure>
<h4 id="修改pom，修改Controller"><a href="#修改pom，修改Controller" class="headerlink" title="修改pom，修改Controller"></a>修改pom，修改Controller</h4><p>pom添加依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MYSQL --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Boot JDBC --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Controller 修改<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DockerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">"select count(*) from test"</span>;</span><br><span class="line">        <span class="keyword">int</span> count = jdbcTemplate.queryForObject(sql, Integer.class);</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重新打包到 docker 中就好了, 再开启运行下就好了</p>
<h1 id="错误集锦"><a href="#错误集锦" class="headerlink" title="错误集锦"></a>错误集锦</h1><h2 id="Exception-caught-lstat-test-docker-1-0-jar-no-such-file-or-directory"><a href="#Exception-caught-lstat-test-docker-1-0-jar-no-such-file-or-directory" class="headerlink" title="Exception caught: lstat test-docker-1.0.jar: no such file or directory"></a>Exception caught: lstat test-docker-1.0.jar: no such file or directory</h2><ul>
<li>报错<br>在编译的时报了下面的错误：<blockquote>
<p>Exception caught: lstat test-docker-1.0.jar: no such file or directory</p>
</blockquote>
</li>
<li>原因：<br>我在 pom.xml 文件中加入了项目的版本号 <version>1.0-SNAPSHOT</version> , 编译成的 jar 包文件名为test-docker-1.0-SNAPSHOT.jar ，与 Dockerfile 里面的指定的 jar 包名称不同，所以报了上面错误</li>
<li>解决方案（二选一）<br>1、去掉 pom.xml 中的 <version>1.0-SNAPSHOT</version><br>2、修改 Dockerfile 的 ADD 语句为 ADD test-docker-1.0.jar app.jar</li>
</ul>
<h2 id="Caused-by-org-apache-http-conn-HttpHostConnectException-Connect-to-localhost-2375-localhost-127-0-0-1-localhost-0-0-0-0-0-0-0-1-failed-Connection-refused-connect"><a href="#Caused-by-org-apache-http-conn-HttpHostConnectException-Connect-to-localhost-2375-localhost-127-0-0-1-localhost-0-0-0-0-0-0-0-1-failed-Connection-refused-connect" class="headerlink" title="Caused by: org.apache.http.conn.HttpHostConnectException: Connect to localhost:2375 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused: connect"></a>Caused by: org.apache.http.conn.HttpHostConnectException: Connect to localhost:2375 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused: connect</h2><h2 id="Caused-by-java-util-concurrent-ExecutionException-com-spotify-docker-client-shaded-javax-ws-rs-ProcessingException-org-apache-http-conn-UnsupportedSchemeException-tcp-protocol-is-not-supported"><a href="#Caused-by-java-util-concurrent-ExecutionException-com-spotify-docker-client-shaded-javax-ws-rs-ProcessingException-org-apache-http-conn-UnsupportedSchemeException-tcp-protocol-is-not-supported" class="headerlink" title="Caused by: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: org.apache.http.conn.UnsupportedSchemeException: tcp protocol is not supported"></a>Caused by: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: org.apache.http.conn.UnsupportedSchemeException: tcp protocol is not supported</h2><p>解决方案：</p>
<ul>
<li>dockerHost 的地址由 tcp 改成 http 协议</li>
</ul>
<h2 id="Caused-by-org-apache-http-conn-HttpHostConnectException-Connect-to-192-168-56-100-2375-192-168-56-100-failed-Connection-refused-connect"><a href="#Caused-by-org-apache-http-conn-HttpHostConnectException-Connect-to-192-168-56-100-2375-192-168-56-100-failed-Connection-refused-connect" class="headerlink" title="Caused by: org.apache.http.conn.HttpHostConnectException: Connect to 192.168.56.100:2375 [/192.168.56.100] failed: Connection refused: connect"></a>Caused by: org.apache.http.conn.HttpHostConnectException: Connect to 192.168.56.100:2375 [/192.168.56.100] failed: Connection refused: connect</h2><p>解决方案：</p>
<ul>
<li>docker 开放端口2375端口</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/centos7 同步时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/centos7 同步时间/" class="post-title-link" itemprop="url">centos7 同步时间</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：15:54:39" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/centos7/" itemprop="url" rel="index"><span itemprop="name">centos7</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="centos7-同步时间"><a href="#centos7-同步时间" class="headerlink" title="centos7 同步时间"></a>centos7 同步时间</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install ntp //安装ntp服务</span><br><span class="line">systemctl enable ntpd //开机启动服务</span><br><span class="line">systemctl start ntpd //启动服务</span><br><span class="line">timedatectl set-timezone Asia/Shanghai //更改时区</span><br><span class="line">timedatectl set-ntp yes //启用ntp同步</span><br><span class="line">ntpq -p //同步时间</span><br></pre></td></tr></table></figure>
<p>参考<a href="https://www.cnblogs.com/tangxiaosheng/p/4986375.html" target="_blank" rel="noopener">https://www.cnblogs.com/tangxiaosheng/p/4986375.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/docker 安装jekins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/docker 安装jekins/" class="post-title-link" itemprop="url">docker 安装jenkins</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：15:57:34" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker-安装jenkins"><a href="#docker-安装jenkins" class="headerlink" title="docker 安装jenkins"></a>docker 安装jenkins</h1><h5 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull  docker.io/jenkins</span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3000:8080 -p 3001:50000 -v /soft/jenkins:/var/jenkins_home  --privileged=true  --name jenkins  jenkins</span><br></pre></td></tr></table></figure>
<p>报错:</p>
<p>touch: cannot touch ‘/var/jenkins_home/copy_reference_file.log’: Permission denied<br>Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</p>
<p><a href="https://www.jianshu.com/p/3671eb8de971" target="_blank" rel="noopener">解决方法：</a></p>
<p>需要修改下目录权限, 因为当映射本地数据卷时，/home/docker/jenkins目录的拥有者为root用户，而容器中jenkins user的uid为1000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R 1000:1000 /soft/jenkins</span><br></pre></td></tr></table></figure>
<p>在安装过程中冒出了管理员的初始密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">6da265d7ad0f448b95bb7501d4b47a8a</span><br><span class="line"></span><br><span class="line">This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>
<p>由于/var/jenkins_home已经被挂载到本地，所以我们可以到/soft/jenkins/secrets/initialAdminPassword</p>
<h5 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h5><p><a href="http://192.168.200.129:3000/" target="_blank" rel="noopener">http://192.168.200.129:3000/</a></p>
<p><img src="./jenkins_1.png" alt="jenkins_1"></p>
<p>输入初始密码后就到了选择插件页面。第一个是安装默认的通用插件，第二个是自定义选择插件。选第一个后，就到了安装页面。</p>
<p>（查了下使用方法，配合git进行自动部署的话，其实就选择3个插件就好了gitea plugin（因为是打算配合gitea），git plugin，还有ssh plugin插件）<img src="./jenkins_2.png" alt="jenkins_2"></p>
<p>有部分插件安装失败：后端也报了插件部署失败的各种错误</p>
<p><img src="./jenkins_3.png" alt="jenkins_3"></p>
<p>先跳过，点击下方的continue，然后就来到了管理员账号设置页面</p>
<p><img src="./jenkins_4.png" alt="jenkins_4"></p>
<p>创建完进来后就到了首页</p>
<p><img src="E:\docker日记\Linux日记\jenkins_5.png" alt="jenkins_5"></p>
<h5 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h5><p>进入到系统管理页后发现有升级jenkins版本的提示，点击后下载了jenkins的war包</p>
<p><img src="./jenkins_6.png" alt="jenkins_6"></p>
<p>通过”系统管理”-&gt;“系统属性” 能看到war包是在/usr/share/jenkins/jenkins.war这个目录下的</p>
<p>下面我们把上传好的war包给拷贝到这个目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker  cp /soft/jenkins.war jenkins:/usr/share/jenkins/</span><br></pre></td></tr></table></figure>
<p>重启容器后发现登录界面变了。升级成功！</p>
<h5 id="jenkins使用"><a href="#jenkins使用" class="headerlink" title="jenkins使用"></a>jenkins使用</h5><p><a href="https://blog.csdn.net/achuDk/article/details/78925081" target="_blank" rel="noopener">jenkins使用</a></p>
<p>运行下面命令进入到docker容器里面的终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -ti aadca348420d /bin/bash</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/docker 安装nexus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/docker 安装nexus/" class="post-title-link" itemprop="url">docker 安装nexus3</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：15:57:54" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker-安装nexus3"><a href="#docker-安装nexus3" class="headerlink" title="docker 安装nexus3"></a>docker 安装nexus3</h1><blockquote>
<p>参考<a href="https://yq.aliyun.com/articles/656964" target="_blank" rel="noopener">https://yq.aliyun.com/articles/656964</a></p>
</blockquote>
<h5 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io/sonatype/nexus3</span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 2000:8081 --name nexus -v nexus-data:/var/nexus-data --restart=always sonatype/nexus3</span><br></pre></td></tr></table></figure>
<p>参数说明： </p>
<p><strong>-i:</strong> 以交互模式运行容器，通常与 -t 同时使用</p>
<p><strong>-t:</strong> 为容器重新分配一个伪输入终端，通常与 -i 同时使用；</p>
<h5 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h5><p><a href="http://192.168.200.129:2000/" target="_blank" rel="noopener">http://192.168.200.129:2000/</a></p>
<p>默认用账号密码是admin/admin123</p>
<p>通过右上角sign in登录</p>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><p>参考<a href="https://blog.csdn.net/smartbetter/article/details/55116889" target="_blank" rel="noopener">https://blog.csdn.net/smartbetter/article/details/55116889</a></p>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>docker容器中的所有配置都是暂时的，重启后的内容会消失</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/docker命令小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/docker命令小结/" class="post-title-link" itemprop="url">docker命令小结</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：15:58:23" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker命令小结"><a href="#docker命令小结" class="headerlink" title="docker命令小结"></a>docker命令小结</h1><table>
<thead>
<tr>
<th>命令用途</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>docker pull</td>
<td>获取image</td>
</tr>
<tr>
<td>docker build</td>
<td>创建image</td>
</tr>
<tr>
<td>docker rm</td>
<td>删除container</td>
</tr>
<tr>
<td>docker cp</td>
<td>主机到宿主机之间拷贝文件</td>
</tr>
<tr>
<td>docker commit</td>
<td>保存改动为新的image</td>
</tr>
<tr>
<td>docker history</td>
<td>查看镜像或者容器的元数据</td>
</tr>
</tbody>
</table>
<p>好奇：如何知道镜像所需要我们去挂载的目录呢？</p>
<p>猜测：参考这篇<a href="https://blog.csdn.net/mmd0308/article/details/77206563" target="_blank" rel="noopener">安装jenkins的过程</a>， 猜测用docker inspect</p>
<p>命令查看，其中有个Volumes数据，就是我们要挂载的目录</p>
<pre><code>&quot;Volumes&quot;: {
    &quot;/var/jenkins_home&quot;: {}
},
</code></pre><p>再看了下gitlab，应该是这样子。</p>
<p>下面的这个信息应该就是我们要映射的端口</p>
<pre><code>&quot;ExposedPorts&quot;: {
    &quot;50000/tcp&quot;: {},
    &quot;8080/tcp&quot;: {}
},
</code></pre><p><a href="https://www.cnblogs.com/ivictor/p/4834864.html" target="_blank" rel="noopener">https://www.cnblogs.com/ivictor/p/4834864.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/lamda/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/lamda/" class="post-title-link" itemprop="url">lamda理解</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：16:01:33" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/杂项/" itemprop="url" rel="index"><span itemprop="name">杂项</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="lamda"><a href="#lamda" class="headerlink" title="lamda"></a>lamda</h5><p>@FunctionaIInterface达到方法赋值给对象</p>
<p>java.util.function包下面有很多常用的这种方法。</p>
<p>只有一个方法的接口都加上了上面那个注解（例如Runnable），也就意味着原有的方法可以用来赋值给对象</p>
<p>：：</p>
<p>括号装参数,{}装实现代码块</p>
<p><img src="E:\docker日记\Linux日记\jdk8_1.png" alt="jdk8_1"></p>
<p>（String input）-&gt;{return }</p>
<p>只有一行代码的情况下。可以省略。</p>
<p>用处：可以把方法作为变量传给另外的方法</p>
<p>idea  .var可以知道类型</p>
<p>stream的collect和reduce(规约)，两个方法比较麻烦</p>
<p>stream还可以进行并发操作</p>
<p>，通过parallel方法去进行遍历操作</p>
<p><img src="E:\docker日记\Linux日记\jdk8_2.png" alt="jdk8_2"></p>
<h5 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h5><h5 id="默认方法"><a href="#默认方法" class="headerlink" title="默认方法"></a>默认方法</h5><p>接口里面可以有方法实现</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/Centos7-Minimal-安装docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lifh">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宏の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/Centos7-Minimal-安装docker/" class="post-title-link" itemprop="url">Centos7 Minimal 安装docker</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 01:54:00 / 修改时间：16:41:12" itemprop="dateCreated datePublished" datetime="2019-03-21T01:54:00+08:00">2019-03-21</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Centos7-Minimal-安装-docker-和-gitlab"><a href="#Centos7-Minimal-安装-docker-和-gitlab" class="headerlink" title="Centos7 Minimal 安装 docker 和 gitlab"></a>Centos7 Minimal 安装 docker 和 gitlab</h1><h2 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h2><p>本系统为 Centos7 minimal 版本</p>
<h3 id="安装-wget"><a href="#安装-wget" class="headerlink" title="安装 wget"></a>安装 wget</h3><pre><code>yum -y install wget
yum -y install setup
yum -y install perl
</code></pre><h3 id="更改-yum-源（参考页面-https-mirrors-163-com-help-centos-html-）"><a href="#更改-yum-源（参考页面-https-mirrors-163-com-help-centos-html-）" class="headerlink" title="更改 yum 源（参考页面 https://mirrors.163.com/.help/centos.html ）"></a>更改 yum 源（参考页面 <a href="https://mirrors.163.com/.help/centos.html" target="_blank" rel="noopener">https://mirrors.163.com/.help/centos.html</a> ）</h3><p>CentOS 自带的yum源为国外地址，常常无法正常更新和安装。</p>
<p>为不影响使用，我们大多会选择国内的一些源地址来提供服务。</p>
<p>这里使用网易的yum源：</p>
<p>先备份原文件：</p>
<pre><code>mv /etc/yum.repos.d/CentOS-Base.repo CentOS-Base.repo.bak
</code></pre><p> 下载yum源：</p>
<pre><code>cd /etc/yum.repos.d/
wget http://mirrors.163.com/.help/CentOS7-Base-163.repo
</code></pre><p>替换yum源：</p>
<pre><code>mv CentOS7-Base-163.repo CentOS-Base.repo
</code></pre><p>将服务器上的软件包信息 现在本地缓存,以提高 搜索 安装软件的速度</p>
<pre><code>yum clean all
yum makecache
</code></pre><p>yum makecache命令，即可正常使用了。</p>
<p>ps: 由于系统是刚装好的。所以更新了下系统的软件</p>
<pre><code>yum update
</code></pre><h1 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h1><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><pre><code>yum install docker
</code></pre><p>在安装 docker 之前，了解了 docker 原来也有私有仓库的概念。大概和 maven 私服仓库差不多吧，毕竟个人也会把应用封装成镜像去部署。</p>
<h2 id="更改docker镜像地址"><a href="#更改docker镜像地址" class="headerlink" title="更改docker镜像地址"></a>更改docker镜像地址</h2><p> docker 默认是以 dockerHub 作为镜像仓库去拉取镜像。但是 dockerHub 的镜像拉取速度太慢，因此我们需要修改 docker 仓镜像地址以提高镜像的拉取速度<br> 这里有几个可以使用：<br> Docker 中国官方镜像加速： <a href="https://registry.docker-cn.com" target="_blank" rel="noopener">https://registry.docker-cn.com</a><br> 网易163 docker镜像： <a href="https://docker.mirrors.ustc.edu.cn" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn</a><br> ustc 的镜像： <a href="https://docker.mirrors.ustc.edu.cn" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn</a><br> 还有 daocloud 和 阿里云的镜像，需要到各自官网注册账号获得地址，这里就不写了</p>
<p>编辑 /etc/docker/daemon.json 文件，加入 registry-mirrors 的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["https://registry.docker-cn.com","https://docker.mirrors.ustc.edu.cn","https://docker.mirrors.ustc.edu.cn"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><pre><code>docker ps
docker search gitlab  #这里打算搜一下gitlab的镜像来着
</code></pre><p>   但是这时候却给我出现了下面的错误<br>   Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?<br>   原来是我只是安装好了docker，还没有启动<br>       systemctl enable docker # 开机自动启动docker</p>
<pre><code>systemctl start docker # 启动docker
systemctl restart docker # 重启dokcer
</code></pre><p>   启动后运行docker ps 出来了，说明启动成功了<br>   [root@dockerServer ~]# docker ps<br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</p>
<h1 id="docker下安装gitlab"><a href="#docker下安装gitlab" class="headerlink" title="docker下安装gitlab"></a>docker下安装gitlab</h1><p>看了下貌似gitlab要从官网变成中文版的话还得打中文补丁，就直接用汉化的社区版吧</p>
<p>1、搜索镜像</p>
<p>docker search gitlab</p>
<p>2、拉取汉化版镜像 </p>
<p>docker pull docker.io/twang2218/gitlab-ce-zh</p>
<p>3、数据持久化保存</p>
<p>因为容器的数据是不能持久化保存的。所以我们需要用 docker volume 的方式将存储的数据映射到操作系统的目录中来。这样就算运行的容器崩溃，我们重新启动一个新的容器，原来容器中的数据还是不会丢失</p>
<p>我们建立了目录 /soft/gitlab 来保存 gitlab 容器中的数据</p>
<p>链接来源：<a href="https://juejin.im/post/5a4c9ff36fb9a04507700fcc" target="_blank" rel="noopener">https://juejin.im/post/5a4c9ff36fb9a04507700fcc</a></p>
<p>4、启动命令</p>
<p>参考官网<a href="https://docs.gitlab.com/omnibus/docker/README.html" target="_blank" rel="noopener">https://docs.gitlab.com/omnibus/docker/README.html</a></p>
<pre><code>docker run \
    --publish 443:443 --publish 80:80 --publish 22:22 \
    --hostname  gitlab.example.com \
    --name gitlab \
    --volume /soft/gitlab/config:/etc/gitlab \
    --volume /soft/gitlab/logs:/var/log/gitlab \
    --volume /soft/gitlab/data:/var/opt/gitlab \
    twang2218/gitlab-ce-zh 
</code></pre><p>这里把主机的 443、80、22 端口直接转发到容器，同时利用 –volume /soft/gitlab/config:/etc/gitlab 、  –volume /soft/gitlab/logs:/var/log/gitlab 、 –volume /soft/gitlab/data:/var/opt/gitlab 这三个参数将 gitlab 的配置、数据和日志持久化到主机文件系统上来。</p>
<p>注意：</p>
<p>1、可以看到最后那一行其实是默认的docker image的名称。由于我们pull的docker image是 docker.io/twang2218/gitlab-ce-zh ，所以启动名称要有相应的变化（去掉前面的docker.io/）。</p>
<p>2、参数名称全写和简写，取第一个字母，如</p>
<p>–publish    对应 -p  </p>
<h1 id="错误集锦"><a href="#错误集锦" class="headerlink" title="错误集锦"></a>错误集锦</h1><p>====================================================</p>
<p>错误1：</p>
<p>/usr/bin/docker-current: Error response from daemon: driver failed programming external connectivity on endpoint gitlab (0aa4d7b96503db6b845cf36574c48e2ed0c5d91b15d205a01022cea241ddce76): Error starting userland proxy: listen tcp 0.0.0.0:22: bind: address already in use.<br>ERRO[0000] error getting events from daemon: net/http: request canceled </p>
<p>原因分析：</p>
<p>因为宿主机（centos7）的22端口被我用SecureCRT终端操作占用了，所以这里不能这样子处理。</p>
<p>暂时转移到别的端口去，后面可能需要在gitlab的配置中配置ssh端口号。<a href="https://blog.whsir.com/post-2429.html" target="_blank" rel="noopener">https://blog.whsir.com/post-2429.html</a></p>
<p>解决方案：</p>
<p>把参数中的22:22改成   1002:22</p>
<p>=====================================================</p>
<p>错误2：</p>
<p>启动后报这个错：cp: cannot create regular file ‘/etc/gitlab/gitlab.rb’: Permission denied</p>
<p>原因分析：</p>
<p>这时由于挂载的本地目录在容器中没有执行权限</p>
<p>解决方案：</p>
<p>在运行容器的时候，给容器加入权限参数 –privileged=true以特权方式启动容器 。</p>
<p>========================================</p>
<p>最终运行命令如下：</p>
<pre><code>docker run \
--publish 1001:443 --publish 1000:80 --publish 1002:22 \
--hostname  gitlab.example.com \
--name gitlab \
--volume /soft/gitlab/config:/etc/gitlab \
--volume /soft/gitlab/logs:/var/log/gitlab \
--volume /soft/gitlab/data:/var/opt/gitlab \
--privileged=true \
--restart always \
twang2218/gitlab-ce-zh
</code></pre><p>参数说明参照<a href="http://www.runoob.com/docker/docker-run-command.html" target="_blank" rel="noopener">http://www.runoob.com/docker/docker-run-command.html</a></p>
<p>然后访问ip就成功了。进去后要你输入默认用户的密码，默认用户是root，这里密码设置成12345678</p>
<p>然后登陆后页面如下：</p>
<p>安装官方版gitlab</p>
<p>看着这个汉化版有点不习惯，还是试一下官方版吧</p>
<p>删掉已经生成的容器</p>
<pre><code>docker rm 容器id
</code></pre><p>删掉已经下载的镜像文件</p>
<pre><code>docker image rm 镜像名称shell
</code></pre><p>再次搜索了下gitlab后发现，gitlab原来分ce（社区版）和ee（企业版），下面使用的是ce版，13.6.4</p>
<p>拉取镜像</p>
<pre><code>docker pull docker.io/gitlab/gitlab-ce
</code></pre><p>设置docker为开机启动</p>
<pre><code>systemctl start docker #启动docker服务
systemctl enable docker #设置docker服务为服务器重启后自动启动
</code></pre><p>启动</p>
<pre><code>sudo docker run --detach \ 
    --hostname gitlab.example.com \
    --publish 1001:443 --publish 1000:80 --publish 1002:22 \
    --name gitlab \
    --restart always \
    --privileged=true \
    --volume /soft/gitlab/config:/etc/gitlab \
    --volume /soft/gitlab/logs:/var/log/gitlab \
    --volume /soft/gitlab/data:/var/opt/gitlab \
    gitlab/gitlab-ce
</code></pre><p>其中 –detach 表示从后台启动,–restart 表示该容器的重启策略</p>
<p>装完后发现。。。还是用快照恢复之前装的中文版吧（因为界面一样啊）</p>
<p>后续：发现gitlab太占资源了，我8g的虚拟机内存，开了gitlab后就只剩下1g了，还是选用gitea试试（发现gitea是Gogs的分支,那就用Gogs来做吧）<a href="https://www.cnblogs.com/Sungeek/p/9188599.html" target="_blank" rel="noopener">https://www.cnblogs.com/Sungeek/p/9188599.html</a></p>
<p>待完善部分</p>
<p>1、docker容器与宿主机交互应该在宿主机中建立专门的用户和权限，而不是使用–privileged=true直接粗暴获取服务器的时间</p>
<p>2、docker容器里的应用，在网络位置可能要作为一个与宿主机（centos7）同一ip网段的一台机器。使用网桥达到跨主机访问</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lifh</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lifh</span>

  

  
</div>

<!-- 隐藏网页底部powered By Hexo / 强力驱动

  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>




  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>

-->


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
